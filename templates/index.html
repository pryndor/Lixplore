{% extends "base.html" %}
{% block content %}

<!-- 🔍 Search Section -->
<section id="search-section" class="search-box sticky-filters">
    <form method="POST" action="{{ url_for('search_page') }}" class="search-form">

        <!-- Source Selector -->
        <label for="source">Select Source:</label>
        <select name="source" id="source" required>
            <option value="" disabled {% if not source %}selected{% endif %}>Select Source</option>
            <option value="pubmed" {% if source=='pubmed' %}selected{% endif %}>PubMed</option>
            <option value="crossref" {% if source=='crossref' %}selected{% endif %}>CrossRef</option>
            <option value="springer" {% if source=='springer' %}selected{% endif %}>Springer</option>
            <option value="europepmc_publications" {% if source=='europepmc_publications' %}selected{% endif %}>EuropePMC Publications</option>
            <option value="europepmc_grants" {% if source=='europepmc_grants' %}selected{% endif %}>EuropePMC Grants</option>
            <option value="clinicaltrials" {% if source=='clinicaltrials' %}selected{% endif %}>Clinical Trials</option>
            <option value="doaj" {% if source=='doaj' %}selected{% endif %}>DOAJ</option>
        </select>

        <!-- Clinical Trials Status Filter -->
        <div id="statusFilter" style="display: {% if source=='clinicaltrials' %}block{% else %}none{% endif %}; width:100%;">
            <label for="status">Status (optional):</label>
            <input type="text" id="status" name="status" placeholder="e.g., RECRUITING, COMPLETED" value="{{ status or '' }}">
        </div>

        <!-- Query Input -->
        <label for="query">Search Query:</label>
        <input type="text" id="query" name="query" placeholder="Enter keyword, DOI, or author" required value="{{ query or '' }}">

        <!-- 📅 Date Range -->
        <div class="date-range">
            <div>
                <label for="start_date">From:</label>
                <input type="date" id="start_date" name="start_date">
            </div>
            <div>
                <label for="end_date">To:</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        </div>

        <!-- Search Button -->
        <div style="width:100%; text-align:center; margin-top:10px;">
            <button type="submit" class="search-btn">Search</button>
        </div>
    </form>
</section>

<!-- 🔹 Results Section -->
	<div class="results-container">
    {% if results %}
        {% for article in results %}
            <div class="result-card">
                
                <!-- 📝 Title -->
                <h3>{{ article.title or "No title available" }}</h3>

                <!-- 📄 Collapsible Abstract -->
                <div class="collapse-content">
                    {{ article.abstract or "No abstract available" }}
                </div>
                <button class="toggle-btn">Show more</button>

                <!-- 🔍 Details -->
                <div class="result-details">
                    <p><strong>Authors:</strong> {{ article.authors | join(', ') if article.authors else 'Not available' }}</p>

                    {% if article.pmid %}
                        <p><strong>PMID:</strong> {{ article.pmid }}</p>
                    {% endif %}

                    {% if article.doi %}
                        <p><strong>DOI:</strong> 
                            <a href="https://doi.org/{{ article.doi }}" target="_blank">{{ article.doi }}</a>
                        </p>
                    {% endif %}

                    {% if article.affiliations %}
                        <p><strong>Affiliations:</strong> {{ article.affiliations | join(', ') }}</p>
                    {% endif %}

                    {% if article.url or article.citation %}
                        <p>
                            {% if article.url %}
                                <a href="{{ article.url }}" target="_blank">View full text</a>
                            {% endif %}
                            
                            {% if article.url and article.citation %}
                                &nbsp;|&nbsp;
                            {% endif %}

                            {% if article.citation %}
                                <a href="#" class="citation-link"
                                   data-citation="{{ article.citation|escapejs }}"
                                   data-title="{{ article.title|escapejs }}"
                                   data-authors="{{ article.authors|join('; ')|escapejs }}"
                                   data-year="{{ article.year or '' }}"
                                   data-doi="{{ article.doi or '' }}">
                                   Cite this article
                                </a>
                            {% endif %}
                    {% if article.oa_pdf_path %}
                        <p class="pdf-line">
                            <strong>PDF:</strong>
                            <a class="pdf-link" href="{{ article.oa_pdf_path }}" target="_blank" rel="noopener">
                                <img src="{{ url_for('static', filename='images/pdf.svg') }}?v=1" alt="View PDF" class="pdf-icon">
                            </a>
                        </p>
                    {% endif %}
                        </p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        {% if query %}
            <p>⚠ No results found for "{{ query }}"</p>
	    {# {% else %}
	    <p>⚠ No results found.</p> #}
        {% endif %}
    {% endif %}
</div>

<!-- 📜 Citation Modal -->
<div id="citationOverlay" class="citation-overlay" onclick="closeCitationModal()"></div>

<div id="citationModal" class="citation-modal">
    <h3>Citation Options</h3>
    <p id="citationText" style="white-space: pre-wrap; background:#f5f5f5; padding:10px; border-radius:8px;"></p>

    <button id="copyCitationBtn">Copy Citation</button>
    <button onclick="triggerDownload('bibtex')">BibTeX</button>
    <button onclick="triggerDownload('ris')">RIS</button>
    <button onclick="triggerDownload('txt')">Plain Text</button>
    <button onclick="triggerDownload('xml_abs')">XML (Abstract)</button>
    <button onclick="triggerDownload('xml_full')">XML (Full Text)</button>
    <button style="background:#ccc; color:#000;" onclick="closeCitationModal()">Close</button>
</div>

<!-- 📜 JS -->
<script>
// Open modal and fill citation info
function openCitationModal(citation, title, authors, year, doi) {
    const overlay = document.getElementById('citationOverlay');
    const modal = document.getElementById('citationModal');
    const citationText = document.getElementById('citationText');

    citationText.textContent = citation || "No citation available.";

    overlay.style.display = 'block';
    modal.style.display = 'block';

    // Store metadata globally for download/export
    window.currentCitation = { citation, title, authors, year, doi };
}

// Close modal
function closeCitationModal() {
    document.getElementById('citationOverlay').style.display = 'none';
    document.getElementById('citationModal').style.display = 'none';
}

// Copy citation
document.getElementById('copyCitationBtn').addEventListener('click', () => {
    const citationText = document.getElementById('citationText').textContent;
    navigator.clipboard.writeText(citationText);
    alert('Citation copied to clipboard!');
});

// Trigger file download (demo behavior)
function triggerDownload(format) {
    const { citation, title } = window.currentCitation || {};
    if (!citation) {
        alert("No citation available to export.");
        return;
    }

    let content = citation;
    let filename = (title ? title.replace(/\s+/g, '_') : 'citation') + '.' + format;

    // Create a blob and trigger a download
    const blob = new Blob([content], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Attach event listeners to "Cite this article" links
document.querySelectorAll('.citation-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        openCitationModal(
            this.dataset.citation,
            this.dataset.title,
            this.dataset.authors,
            this.dataset.year,
            this.dataset.doi
        );
    });
});
</script>

<script src="{{ url_for('static', filename='js/results.js') }}"></script>

{% endblock %}


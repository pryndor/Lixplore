{% extends "base.html" %}
{% block content %}

<!-- 🔍 Search Section -->
<section id="search-section" class="search-box sticky-filters">
    <form method="POST" action="{{ url_for('search_page') }}" class="search-form">

        <!-- Source Selector -->
        <label for="source">Select Source:</label>
        <select name="source" id="source" required>
            <option value="" disabled {% if not source %}selected{% endif %}>Select Source</option>
            <option value="pubmed" {% if source=='pubmed' %}selected{% endif %}>PubMed</option>
            <option value="crossref" {% if source=='crossref' %}selected{% endif %}>CrossRef</option>
            <option value="springer" {% if source=='springer' %}selected{% endif %}>Springer</option>
            <option value="europepmc_publications" {% if source=='europepmc_publications' %}selected{% endif %}>
                EuropePMC Publications</option>
            <option value="europepmc_grants" {% if source=='europepmc_grants' %}selected{% endif %}>EuropePMC Grants
            </option>
            <option value="clinicaltrials" {% if source=='clinicaltrials' %}selected{% endif %}>Clinical Trials</option>
            <option value="doaj" {% if source=='doaj' %}selected{% endif %}>DOAJ</option>
        </select>

        <!-- Clinical Trials Status Filter -->
        <div id="statusFilter"
            style="display: {% if source=='clinicaltrials' %}block{% else %}none{% endif %}; width:100%;">
            <label for="status">Status (optional):</label>
            <input type="text" id="status" name="status" placeholder="e.g., RECRUITING, COMPLETED"
                value="{{ status or '' }}">
        </div>

        <!-- Query Input -->
        <label for="query">Search Query:</label>
        <input type="text" id="query" name="query" placeholder="Enter keyword, DOI, or author" required
            value="{{ query or '' }}">

        <!-- 📅 Date Range -->
        <div class="date-range">
            <div>
                <label for="start_date">From:</label>
                <input type="date" id="start_date" name="start_date">
            </div>
            <div>
                <label for="end_date">To:</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        </div>

        <!-- Search Button -->
        <div style="width:100%; text-align:center; margin-top:10px;">
            <button type="submit" class="search-btn">Search</button>
        </div>
    </form>
</section>

	    <!--
        <button id="loadMoreBtn" 
                data-source="{{ source }}" 
                data-query="{{ query }}" 
                style="padding: 10px 15px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Load More
        </button>
 -->


<!-- 📜 Citation Modal -->
<div id="citationOverlay" class="citation-overlay" onclick="closeCitationModal()"></div>
<div id="citationModal" class="citation-modal">
    <h3>Citation Options</h3>
    <button id="copyCitationBtn">Copy Citation</button>
    <button onclick="triggerDownload('bibtex')">BibTeX</button>
    <button onclick="triggerDownload('ris')">RIS</button>
    <button onclick="triggerDownload('txt')">Plain Text</button>
    <button onclick="triggerDownload('xml_abs')">XML (Abstract)</button>
    <button onclick="triggerDownload('xml_full')">XML (Full Text)</button>
    <button style="background:#ccc; color:#000;" onclick="closeCitationModal()">Close</button>
</div>


<!-- 📜 Scripts -->
<script>
    let currentCitation = "", currentTitle = "", currentAuthors = "", currentYear = "", currentDOI = "";
    function openCitationModal ( citation, title, authors, year, doi )
    {
        currentCitation = citation; currentTitle = title; currentAuthors = authors; currentYear = year; currentDOI = doi;
        document.getElementById( "citationOverlay" ).style.display = "block";
        document.getElementById( "citationModal" ).style.display = "block";
    }
    function closeCitationModal ()
    {
        document.getElementById( "citationOverlay" ).style.display = "none";
        document.getElementById( "citationModal" ).style.display = "none";
    }
    document.getElementById( "copyCitationBtn" ).onclick = function ()
    {
        navigator.clipboard.writeText( currentCitation ).then( () => alert( "Citation copied!" ) ).catch( () => alert( "Failed to copy citation" ) );
    };
    function triggerDownload ( format )
    {
        let content = "", filename = "";
        if ( format === "bibtex" ) { content = `@article{${ currentAuthors.split( ' ' )[ 0 ] }_${ currentYear }, title={${ currentTitle }}, author={${ currentAuthors }}, year={${ currentYear }}, doi={${ currentDOI }}}`; filename = "citation.bib"; }
        else if ( format === "ris" ) { content = `TY  - JOUR\nTI  - ${ currentTitle }\nAU  - ${ currentAuthors }\nPY  - ${ currentYear }\nDO  - ${ currentDOI }\nER  -`; filename = "citation.ris"; }
        else if ( format === "txt" ) { content = `${ currentAuthors } (${ currentYear }). ${ currentTitle }. DOI: ${ currentDOI }`; filename = "citation.txt"; }
        else if ( format === "xml_abs" ) { content = `<abstract>\n<title>${ currentTitle }</title>\n<authors>${ currentAuthors }</authors>\n<year>${ currentYear }</year>\n<doi>${ currentDOI }</doi>\n<abstractText>${ currentCitation }</abstractText>\n</abstract>`; filename = "citation_abstract.xml"; }
        else if ( format === "xml_full" ) { content = `<fulltext>\n<title>${ currentTitle }</title>\n<authors>${ currentAuthors }</authors>\n<year>${ currentYear }</year>\n<doi>${ currentDOI }</doi>\n<fullText>${ currentCitation }</fullText>\n</fulltext>`; filename = "citation_full.xml"; }
        const blob = new Blob( [ content ], { type: "text/plain" } ); const link = document.createElement( "a" );
        link.href = URL.createObjectURL( blob ); link.download = filename; link.click(); URL.revokeObjectURL( link.href );
    }
/*
    // Pagination is now handled server-side with proper page navigation

    // Screening Modal Functions
    function showCreateScreeningModal ()
    {
        document.getElementById( "screeningModal" ).style.display = "block";
    }

    function closeScreeningModal ()
    {
        document.getElementById( "screeningModal" ).style.display = "none";
    }
*/
<script>
/* 
// Load More Logic

let currentStart = 20;
const maxResults = 20;
const loadMoreBtn = document.getElementById("loadMoreBtn");
if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", function () {
        loadMoreBtn.textContent = "Loading...";
        const source = this.dataset.source;
        const query = this.dataset.query;
        fetch(`/load_more?source=${source}&query=${encodeURIComponent(query)}&start=${currentStart}&max=${maxResults}`)
            .then(r => r.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const container = document.getElementById("resultsContainer");
                    data.results.forEach(article => {
                        const div = document.createElement("div");
                        div.classList.add("result-card");
                        div.innerHTML = `
                            <h3>${article.title}</h3>
                            ${article.abstract ? `<p><strong>Abstract:</strong> ${article.abstract}</p>` : ""}
                            ${article.authors ? `<p><strong>Authors:</strong> ${article.authors.join(", ")}</p>` : ""}
                            ${article.pmid ? `<p><strong>PMID:</strong> ${article.pmid}</p>` : ""}
                            ${article.doi ? `<p><strong>DOI:</strong> ${article.doi}</p>` : ""}
                            <div class="link-section">
                                ${article.url ? `<a href="${article.url}" target="_blank" class="fulltext-link">Full Text</a>` : `<span class="fulltext-link disabled">Full Text N/A</span>`}
                                ${article.citation ? `<a href="#" class="citation-link" onclick="openCitationModal(\`${article.citation.replace(/`/g, '\\`')}\`,\`${article.title.replace(/`/g, '\\`')}\`,\`${article.authors.join('; ').replace(/`/g, '\\`')}\`,\`${article.year || ''}\`,\`${article.doi || ''}\`)">Cite this article</a>` : `<span class="citation-link disabled">Citation N/A</span>`}
                            </div>
                            <hr>`;
                        container.appendChild(div);
                    });
                    currentStart = data.next_start;
                    loadMoreBtn.textContent = "Load More";
                } else {
                    loadMoreBtn.style.display = "none";
                }
            })
            .catch(() => { alert("Failed to load more results."); loadMoreBtn.textContent = "Load More"; });
    });
}

*/
</script> 

{% endblock %}

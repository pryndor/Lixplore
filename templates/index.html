{% extends "base.html" %}
{% block content %}



<!-- ðŸ” Search Section -->
<section id="search-section" class="search-box sticky-filters">
    <form method="POST" action="{{ url_for('search_page') }}" class="search-form">

        <!-- Source Selector -->
        <label for="source">Select Source:</label>
        <select name="source" id="source" required>
            <option value="" disabled {% if not source %}selected{% endif %}>Select Source</option>
            <option value="pubmed" {% if source=='pubmed' %}selected{% endif %}>PubMed</option>
            <option value="crossref" {% if source=='crossref' %}selected{% endif %}>CrossRef</option>
            <option value="springer" {% if source=='springer' %}selected{% endif %}>Springer</option>
            <option value="europepmc_publications" {% if source=='europepmc_publications' %}selected{% endif %}>
                EuropePMC Publications</option>
            <option value="europepmc_grants" {% if source=='europepmc_grants' %}selected{% endif %}>EuropePMC Grants
            </option>
            <option value="clinicaltrials" {% if source=='clinicaltrials' %}selected{% endif %}>Clinical Trials</option>
            <option value="doaj" {% if source=='doaj' %}selected{% endif %}>DOAJ</option>
        </select>

        <!-- Clinical Trials Status Filter -->
        <div id="statusFilter"
            style="display: {% if source=='clinicaltrials' %}block{% else %}none{% endif %}; width:100%;">
            <label for="status">Status (optional):</label>
            <input type="text" id="status" name="status" placeholder="e.g., RECRUITING, COMPLETED"
                value="{{ status or '' }}">
        </div>

        <!-- Query Input -->
        <label for="query">Search Query:</label>
        <input type="text" id="query" name="query" placeholder="Enter keyword, DOI, or author" required
            value="{{ query or '' }}">

        <!-- ðŸ“… Date Range -->
        <div class="date-range">
            <div>
                <label for="start_date">From:</label>
                <input type="date" id="start_date" name="start_date">
            </div>
            <div>
                <label for="end_date">To:</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        </div>

        <!-- Search Button -->
        <div style="width:100%; text-align:center; margin-top:10px;">
            <button type="submit" class="search-btn">Search</button>
        </div>
    </form>
</section>

<!-- ðŸ”¹ Results Section -->
<div class="results-container" id="resultsContainer">
    {% if results %}
        {% for article in results %}
            <div class="result-card">

                <!-- Title -->
                <h3>{{ article.title or "No title available" }}</h3>

                <!-- Abstract Toggle -->
                {% if article.abstract %}
                    <p class="abstract-preview" onclick="toggleAbstract(this)">
                        {{ article.abstract }}
                        <span class="read-toggle">â–¼ Read more</span>
                    </p>
                {% else %}
                    <p><em>No abstract available</em></p>
                {% endif %}

                <!-- Article Details -->
                <div class="result-details">
                    <p><strong>Authors:</strong> {{ article.authors | join(', ') if article.authors else 'Not available' }}</p>
                    
                    {% if article.pmid %}
                        <p><strong>PMID:</strong> {{ article.pmid }}</p>
                    {% endif %}

                    <p><strong>DOI:</strong>
                        {% if article.doi %}
                            <a href="https://doi.org/{{ article.doi }}" target="_blank">{{ article.doi }}</a>
                        {% else %}
                            Not available
                        {% endif %}
                    </p>

                    <p><strong>Affiliations:</strong> {{ article.affiliations | join(', ') if article.affiliations else 'Not available' }}</p>

                    {% if article.url %}
                        <p><strong>Full Text:</strong> <a href="{{ article.url }}" target="_blank">Link</a></p>
                    {% endif %}

                    {% if article.oa_pdf_path %}
                        <p class="pdf-line">
                            <strong>PDF:</strong>
                            <a class="pdf-link" href="{{ article.oa_pdf_path }}" target="_blank" rel="noopener">
                                <img src="{{ url_for('static', filename='images/pdf.svg') }}?v=1" alt="PDF" class="pdf-icon">
                                View PDF
                            </a>
                        </p>
                    {% endif %}

                    {% if article.citation %}
                        <p>
                            <a href="#" class="citation-link" onclick="openCitationModal('{{ article.citation|escapejs }}', '{{ article.title|escapejs }}', '{{ article.authors|join('; ')|escapejs }}', '{{ article.year or '' }}', '{{ article.doi or '' }}')">Cite this article</a>
                        </p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        {% if query %}
            <p>âš  No results found for "{{ query }}"</p>
        {% endif %}
    {% endif %}
</div>

<!-- ðŸ“œ Citation Modal -->
<div id="citationOverlay" class="citation-overlay" onclick="closeCitationModal()"></div>
<div id="citationModal" class="citation-modal">
    <h3>Citation Options</h3>
    <button id="copyCitationBtn">Copy Citation</button>
    <button onclick="triggerDownload('bibtex')">BibTeX</button>
    <button onclick="triggerDownload('ris')">RIS</button>
    <button onclick="triggerDownload('txt')">Plain Text</button>
    <button onclick="triggerDownload('xml_abs')">XML (Abstract)</button>
    <button onclick="triggerDownload('xml_full')">XML (Full Text)</button>
    <button style="background:#ccc; color:#000;" onclick="closeCitationModal()">Close</button>
</div>

<!-- ðŸ“œ Scripts -->
<script>
    let currentCitation = "", currentTitle = "", currentAuthors = "", currentYear = "", currentDOI = "";

    function openCitationModal(citation, title, authors, year, doi) {
        currentCitation = citation;
        currentTitle = title;
        currentAuthors = authors;
        currentYear = year;
        currentDOI = doi;
        document.getElementById("citationOverlay").style.display = "block";
        document.getElementById("citationModal").style.display = "block";
    }

    function closeCitationModal() {
        document.getElementById("citationOverlay").style.display = "none";
        document.getElementById("citationModal").style.display = "none";
    }

    document.getElementById("copyCitationBtn").onclick = function() {
        navigator.clipboard.writeText(currentCitation)
            .then(() => alert("Citation copied!"))
            .catch(() => alert("Failed to copy citation"));
    };

    function triggerDownload(format) {
        let content = "", filename = "";
        if (format === "bibtex") {
            content = `@article{${currentAuthors.split(' ')[0]}_${currentYear}, title={${currentTitle}}, author={${currentAuthors}}, year={${currentYear}}, doi={${currentDOI}}}`;
            filename = "citation.bib";
        } else if (format === "ris") {
            content = `TY  - JOUR\nTI  - ${currentTitle}\nAU  - ${currentAuthors}\nPY  - ${currentYear}\nDO  - ${currentDOI}\nER  -`;
            filename = "citation.ris";
        } else if (format === "txt") {
            content = `${currentAuthors} (${currentYear}). ${currentTitle}. DOI: ${currentDOI}`;
            filename = "citation.txt";
        } else if (format === "xml_abs") {
            content = `<abstract>\n<title>${currentTitle}</title>\n<authors>${currentAuthors}</authors>\n<year>${currentYear}</year>\n<doi>${currentDOI}</doi>\n<abstractText>${currentCitation}</abstractText>\n</abstract>`;
            filename = "citation_abstract.xml";
        } else if (format === "xml_full") {
            content = `<fulltext>\n<title>${currentTitle}</title>\n<authors>${currentAuthors}</authors>\n<year>${currentYear}</year>\n<doi>${currentDOI}</doi>\n<fullText>${currentCitation}</fullText>\n</fulltext>`;
            filename = "citation_full.xml";
        }
        const blob = new Blob([content], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    // Abstract toggle
    function toggleAbstract(el) {
        el.classList.toggle('expanded');
        const toggleText = el.querySelector('.read-toggle');
        toggleText.textContent = el.classList.contains('expanded') ? 'â–² Read less' : 'â–¼ Read more';
    }

    // Show/hide status filter for clinical trials
    const sourceSelect = document.getElementById("source");
    const statusDiv = document.getElementById("statusFilter");
    sourceSelect.addEventListener("change", function() {
        if (this.value === "clinicaltrials") {
            statusDiv.style.display = "block";
        } else {
            statusDiv.style.display = "none";
        }
    });
</script>

{% endblock %}





